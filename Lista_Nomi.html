<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Nomi (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .completed {
            text-decoration: line-through;
            color: #6b7280; /* Grigio più scuro per il testo depennato */
            background-color: #374151 !important; /* Sfondo più scuro per l'elemento completato */
        }
        .name-item {
            transition: all 0.3s ease-in-out;
        }
        .view { display: none; }
        ::placeholder { color: #9ca3af; opacity: 1; }
        .fade-out { animation: fadeOut 0.3s ease-out forwards; }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        .sort-direction-btn.active { background-color: #4b5563; }
        #loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 200px; }
        #loader { border: 4px solid #4b5563; border-top: 4px solid #3b82f6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen py-8">

    <div class="w-full max-w-2xl mx-auto bg-gray-800 rounded-2xl shadow-lg p-6 md:p-8">
        
        <div id="loadingView" class="view" style="display: block;">
            <div id="loader-container">
                <div id="loader"></div>
                <p class="text-gray-400 mt-4">Connessione in corso...</p>
            </div>
        </div>

        <!-- Vista Menu Principale -->
        <div id="homeView" class="view">
            <header class="mb-8 text-center">
                <h1 class="text-3xl md:text-4xl font-bold text-white">Menu Principale</h1>
                <p class="text-gray-400 mt-2">Seleziona una vista.</p>
            </header>
            <div class="space-y-4">
                <button id="showListViewBtn" class="w-full text-lg bg-blue-600 text-white font-semibold py-4 px-6 rounded-xl hover:bg-blue-700">Lista</button>
                <button id="showCompletedViewBtn" class="w-full text-lg bg-gray-600 text-white font-semibold py-4 px-6 rounded-xl hover:bg-gray-700">Persone già entrate</button>
                <button id="showAddViewBtn" class="w-full text-lg bg-teal-600 text-white font-semibold py-4 px-6 rounded-xl hover:bg-teal-700">Aggiungi Nome</button>
            </div>
        </div>
        
        <!-- Vista Aggiungi Nome -->
        <div id="addView" class="view">
            <header class="mb-6 flex items-center justify-between">
                <h1 class="text-3xl font-bold text-white">Aggiungi Nome</h1>
                <button class="back-btn text-blue-400 hover:underline">Indietro</button>
            </header>
            <div class="space-y-4">
                 <input type="text" id="newNameInput" placeholder="Inserisci il nuovo nome..." class="w-full pl-4 pr-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-teal-500">
                 <button id="saveNameBtn" class="w-full text-lg bg-teal-600 text-white font-semibold py-3 px-6 rounded-xl hover:bg-teal-700">Salva</button>
            </div>
        </div>

        <!-- Viste Lista -->
        <div id="listView" class="view">
            <header class="mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-3xl font-bold text-white">Da selezionare</h1>
                    </div>
                    <button class="back-btn text-blue-400 hover:underline">Indietro</button>
                </div>
            </header>
            <div class="relative my-6">
                <input type="text" id="searchInput" placeholder="Cerca un nome..." class="w-full pl-4 pr-10 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-blue-500">
                <button id="clearSearchInput" class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" style="display: none;">
                    <svg class="w-6 h-6 text-gray-500 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="overflow-y-auto max-h-[60vh] pr-2">
                <ul id="namesList" class="space-y-3"></ul>
            </div>
        </div>

        <div id="completedView" class="view">
             <header class="mb-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-3xl font-bold text-white">Già entrati</h1>
                    </div>
                    <button class="back-btn text-blue-400 hover:underline">Indietro</button>
                </div>
            </header>
            <div class="relative my-6">
                <input type="text" id="searchCompletedInput" placeholder="Cerca tra gli entrati..." class="w-full pl-4 pr-10 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-blue-500">
                 <button id="clearSearchCompletedInput" class="absolute inset-y-0 right-0 flex items-center pr-3 cursor-pointer" style="display: none;">
                    <svg class="w-6 h-6 text-gray-500 hover:text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="overflow-y-auto max-h-[60vh] pr-2">
                <ul id="completedNamesList" class="space-y-3"></ul>
            </div>
        </div>
        
        <footer class="mt-6 text-center">
            <p id="counter" class="text-gray-400"></p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, getDocs, writeBatch, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', () => {
            let people = [];
            let isInitialLoad = true;
            let currentViewId = 'loadingView';

            // Elementi UI
            const views = document.querySelectorAll('.view');
            const searchInput = document.getElementById('searchInput');
            const searchCompletedInput = document.getElementById('searchCompletedInput');
            const clearSearchInput = document.getElementById('clearSearchInput');
            const clearSearchCompletedInput = document.getElementById('clearSearchCompletedInput');
            const namesList = document.getElementById('namesList');
            const completedNamesList = document.getElementById('completedNamesList');
            const counter = document.getElementById('counter');
            const showListViewBtn = document.getElementById('showListViewBtn');
            const showCompletedViewBtn = document.getElementById('showCompletedViewBtn');
            const showAddViewBtn = document.getElementById('showAddViewBtn');
            const backBtns = document.querySelectorAll('.back-btn');
            const newNameInput = document.getElementById('newNameInput');
            const saveNameBtn = document.getElementById('saveNameBtn');
            const loaderContainer = document.getElementById('loader-container');

            // Inizializzazione Firebase
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const peopleCollectionRef = collection(db, `artifacts/${appId}/public/data/people`);

            const showView = (viewId) => {
                currentViewId = viewId;
                views.forEach(view => view.style.display = 'none');
                document.getElementById(viewId).style.display = 'block';
                renderCurrentView();
            };

            const renderCurrentView = () => {
                if (currentViewId === 'listView') renderPendingList();
                if (currentViewId === 'completedView') renderCompletedList();
                updateCounter();
            };
            
            const sortPeople = (list) => {
                list.sort((a, b) => a.name.localeCompare(b.name));
                return list;
            };

            const renderPendingList = () => {
                const searchTerm = searchInput.value.toLowerCase();
                let pendingPeople = people.filter(p => !p.completed && p.name.toLowerCase().includes(searchTerm));
                pendingPeople = sortPeople(pendingPeople);
                namesList.innerHTML = '';
                if (pendingPeople.length === 0) {
                    namesList.innerHTML = `<li class="text-center text-gray-400 py-4">Nessun nome da selezionare.</li>`;
                } else {
                    pendingPeople.forEach(person => namesList.appendChild(createNameElement(person)));
                }
            };
            
            const renderCompletedList = () => {
                const searchTerm = searchCompletedInput.value.toLowerCase();
                let completedPeople = people.filter(p => p.completed && p.name.toLowerCase().includes(searchTerm));
                completedPeople = sortPeople(completedPeople);
                completedNamesList.innerHTML = '';
                if (completedPeople.length === 0) {
                    completedNamesList.innerHTML = `<li class="text-center text-gray-400 py-4">Nessuna persona è ancora entrata.</li>`;
                } else {
                    completedPeople.forEach(person => completedNamesList.appendChild(createNameElement(person)));
                }
            };

            const createNameElement = (person) => {
                const li = document.createElement('li');
                li.className = 'name-item p-4 bg-gray-700 rounded-xl flex items-center justify-between';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = person.name;
                nameSpan.className = 'flex-grow cursor-pointer';
                if (person.completed) li.classList.add('completed');

                nameSpan.addEventListener('click', (event) => {
                    event.currentTarget.parentElement.classList.add('fade-out');
                    setTimeout(() => toggleCompleted(person.id, person.completed), 300); 
                });

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'ml-4 p-1 rounded-full hover:bg-red-500/20';
                deleteBtn.innerHTML = `<svg class="w-5 h-5 text-gray-400 hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
                
                deleteBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    event.currentTarget.parentElement.classList.add('fade-out');
                    setTimeout(() => deleteName(person.id), 300);
                });

                li.appendChild(nameSpan);
                li.appendChild(deleteBtn);
                return li;
            };

            const deleteName = async (id) => {
                const personDocRef = doc(db, `artifacts/${appId}/public/data/people`, id);
                await deleteDoc(personDocRef);
            };

            const toggleCompleted = async (id, currentStatus) => {
                const personDocRef = doc(db, `artifacts/${appId}/public/data/people`, id);
                await updateDoc(personDocRef, { completed: !currentStatus });
            };
            
            const updateCounter = () => {
                const completedCount = people.filter(p => p.completed).length;
                const totalCount = people.length;
                counter.textContent = `Entrati: ${completedCount} / ${totalCount}`;
            };

            const handleClearButtonVisibility = (input, clearButton) => {
                clearButton.style.display = input.value.length > 0 ? 'flex' : 'none';
            };

            const addNewName = async () => {
                const name = newNameInput.value.trim();
                if (name) {
                    await addDoc(peopleCollectionRef, { name: name, completed: false });
                    newNameInput.value = '';
                    saveNameBtn.textContent = 'Aggiunto!';
                    saveNameBtn.classList.remove('bg-teal-600', 'hover:bg-teal-700');
                    saveNameBtn.classList.add('bg-blue-600');
                    setTimeout(() => {
                        saveNameBtn.textContent = 'Salva';
                        saveNameBtn.classList.add('bg-teal-600', 'hover:bg-teal-700');
                        saveNameBtn.classList.remove('bg-blue-600');
                    }, 1000);
                }
            };

            const seedDatabase = async () => {
                const querySnapshot = await getDocs(peopleCollectionRef);
                if (querySnapshot.empty) {
                    console.log("Database vuoto, inserimento dati iniziali...");
                    const initialNames = [
                        "Alessandro Gernone", "Alessandro Guerricchio", "Alessia Clemente", "Alessio Milella",
                        "Alessandra Savino", "Alexandra Ugnarovskaia", "Andrea Pasculli", "Andrea Ronco",
                        "Antonello Garofalo", "Antonello Giuliani", "Antonio More", "Christian Altini",
                        "Claudia de T...", "Daniele Iacobbe", "Dario Lamattina", "Davide D’Aloisio",
                        "Davide Venerando", "Diego Antonacci", "Elisa Vozza", "Fabrizio Rossi",
                        "Felice Lapertosa", "Flavio Amoruso", "Francesca Ricca", "Francesco Rotondo",
                        "Gabriele Carnimeo", "Gaetano Antonino", "Gianluca Marinelli", "Giorgia Renzullo",
                        "Giorgia Loschiavo", "Giovanni Lopedote", "Giovanni Mongelli", "Giovanni Pastore",
                        "Giulia Losurdo", "Giulia Perinotto", "Giulia Tozzi", "Giuseppe Salomone",
                        "Ginevra Torricella", "Lorenzo Grimaldi", "Luca Loiacono", "Luciano Marsico",
                        "Marcello Lupis Tafaro", "Marco Facchini", "Maria Francesca Guerricchio",
                        "Margherita Profili", "Martin Calabrese", "Martina Gabriele", "Martina Giuliani",
                        "Martina Losurdo", "Massimiliano Rossi", "Michele De Santis", "Michele Lisco",
                        "Miriam Giannini", "Nicolò Amoruso", "Nicole Ciani", "Nicole Fino", "Noemi Vidor",
                        "Rachele Rivoli", "Rebecca Pappagallo", "Roberto Mezzina", "Roberta Cappiello",
                        "Roberta Ranieri", "Roberta Sassanelli", "Samuele Genchi", "Sara D'Alessandro",
                        "Serena Volpicella", "Simone Adorisio", "Simona D’Amelio", "Sophia Rotunno",
                        "Stefano Fiore", "Tommaso Ranieri", "Vittoria Stellacci"
                    ];
                    const batch = writeBatch(db);
                    initialNames.forEach(name => {
                        const newDocRef = doc(peopleCollectionRef);
                        batch.set(newDocRef, { name: name, completed: false });
                    });
                    await batch.commit();
                }
            };
            
            const startFirestoreListeners = async () => {
                await seedDatabase();
                onSnapshot(peopleCollectionRef, (snapshot) => {
                    people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (isInitialLoad) {
                        showView('homeView');
                        isInitialLoad = false;
                    } else {
                        renderCurrentView();
                    }
                }, (error) => {
                    console.error("Errore di connessione al database:", error);
                    loaderContainer.innerHTML = '<p class="text-red-400">Impossibile connettersi.</p>';
                });
            };

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    startFirestoreListeners();
                }
            });

            const authenticate = async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Autenticazione fallita:", error);
                    loaderContainer.innerHTML = '<p class="text-red-400">Autenticazione fallita.</p>';
                }
            };
            
            showListViewBtn.addEventListener('click', () => showView('listView'));
            showCompletedViewBtn.addEventListener('click', () => showView('completedView'));
            showAddViewBtn.addEventListener('click', () => showView('addView'));
            backBtns.forEach(btn => btn.addEventListener('click', () => showView('homeView')));
            saveNameBtn.addEventListener('click', addNewName);
            searchInput.addEventListener('input', () => { renderPendingList(); handleClearButtonVisibility(searchInput, clearSearchInput); });
            searchCompletedInput.addEventListener('input', () => { renderCompletedList(); handleClearButtonVisibility(searchCompletedInput, clearSearchCompletedInput); });
            clearSearchInput.addEventListener('click', () => { searchInput.value = ''; renderPendingList(); handleClearButtonVisibility(searchInput, clearSearchInput); searchInput.focus(); });
            clearSearchCompletedInput.addEventListener('click', () => { searchCompletedInput.value = ''; renderCompletedList(); handleClearButtonVisibility(searchCompletedInput, clearSearchCompletedInput); searchCompletedInput.focus(); });

            authenticate();
        });
    </script>

</body>
</html>
